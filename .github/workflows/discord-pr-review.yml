name: Notify Discord on PR Review

on:
  pull_request_target:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Send message to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REVIEW_STATE: ${{ github.event.review.state }}
          REVIEW_BODY: ${{ github.event.review.body }}
          REVIEWER: ${{ github.event.review.user.login }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          echo "Sending PR Review notification to Discord..."

          # ğŸ”’ Secret ê°€ë“œ
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "âŒ DISCORD_WEBHOOK_URL is empty. Check secrets & event context."
            exit 1
          fi

          # ğŸ“¦ JSON payload ìƒì„±
          PAYLOAD=$(jq -n \
            --arg content "**ğŸ” PR ë¦¬ë·°ê°€ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.**" \
            --arg reviewer "$REVIEWER" \
            --arg state "$REVIEW_STATE" \
            --arg body "${REVIEW_BODY:-No comment}" \
            --arg prtitle "$PR_TITLE" \
            --arg prurl "$PR_URL" \
            '{
              content: $content,
              embeds: [
                {
                  title: $prtitle,
                  url: $prurl,
                  color: 3447003,
                  fields: [
                    { name: "ğŸ‘¤ ë¦¬ë·°ì–´", value: $reviewer, inline: true },
                    { name: "ğŸ“Œ ë¦¬ë·° ìƒíƒœ", value: $state, inline: true },
                    { name: "ğŸ’¬ ë¦¬ë·° ë‚´ìš©", value: $body }
                  ]
                }
              ]
            }'
          )

          # ğŸš€ Discord ì „ì†¡
          curl -sS \
            -H "Content-Type: application/json" \
            -X POST \
            -d "$PAYLOAD" \
            "$DISCORD_WEBHOOK_URL"
